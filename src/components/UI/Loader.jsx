// Loader.jsx
import React, { useEffect, useRef, useState } from "react";
import gsap from "gsap";

const Loader = ({ loading }) => {
  const pathRef1 = useRef(null);
  const pathRef2 = useRef(null);
  const loaderRef = useRef(null);
  const [visible, setVisible] = useState(true);

  useEffect(() => {
    if (!pathRef1.current || !pathRef2.current) return;

    const path1 = pathRef1.current;
    const path2 = pathRef2.current;
    const length1 = path1.getTotalLength();
    const length2 = path2.getTotalLength();

    // Initial setup for both paths
    gsap.set(path1, {
      strokeDasharray: length1,
      strokeDashoffset: length1,
    });
    gsap.set(path2, {
      strokeDasharray: length2,
      strokeDashoffset: length2,
    });

    // Animate paths for exactly 3 seconds
    const pathAnim1 = gsap.to(path1, {
      strokeDashoffset: 0,
      duration: 3,
      ease: "power2.inOut",
    });

    const pathAnim2 = gsap.to(path2, {
      strokeDashoffset: 0,
      duration: 3,
      ease: "power2.inOut",
      delay: 0.2, // slight offset for visual interest
    });

    // After 3 seconds, fade out the loading page
    gsap.delayedCall(3, () => {
      gsap.to(loaderRef.current, {
        opacity: 0,
        duration: 0.8,
        ease: "power2.inOut",
        onComplete: () => setVisible(false),
      });
    });

    // Handle external loading prop changes
    if (!loading) {
      pathAnim1.pause();
      pathAnim2.pause();

      gsap.to(loaderRef.current, {
        opacity: 0,
        duration: 0.8,
        ease: "power2.inOut",
        onComplete: () => setVisible(false),
      });
    }

    return () => {
      pathAnim1.kill();
      pathAnim2.kill();
    };
  }, [loading]);

  if (!visible) return null;

  return (
    <div
      ref={loaderRef}
      className="loader-container"
    >
      <div className="loader-icon">
        <svg
          className="loader-svg"
          width="687"
          height="801"
          viewBox="0 0 687 801"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            ref={pathRef1}
            className="flex items-center justify-center"
            d="M1 765.55C44.3928 645.311 94.8514 608.786 261.636 634.447C365.764 653.905 411.329 639.815 466.135 563.054C467.487 636.812 476.625 672.695 526.282 714.925C558.116 744.272 573.084 762.354 594.448 798C592.906 755.532 582.151 730.626 528.955 682.474C498.771 649.103 485.482 627.732 482.174 574.737C478.049 539.983 475.019 521.233 462.125 495.556C542.477 486.829 569.493 469.774 566.38 404.693C545.338 465.776 521.547 483.992 452.769 481.277C439.688 479.421 425.802 484.162 400.642 492.96C379.643 497.254 369.483 493.271 353.861 476.085C349.793 465.703 354.674 459.619 361.881 448.826C387.737 422.731 399.371 410.079 404.652 398.203L432.72 359.261C418.096 333.201 401.649 326.329 359.207 326.81C372.82 368.657 380.103 393.733 404.652 385.221L385.939 356.664C384.279 345.559 386.916 344.742 395.296 348.875L412.671 365.75C423.653 370.057 428.693 363.163 438.067 354.068C446.821 340.107 446.398 333.256 435.393 322.915C411.329 308.941 395.932 306.122 368.564 300.848C283.235 279.934 249.499 252.644 220.202 169.746C254.023 214.946 274.984 246.427 292.378 241.138C299.687 243.237 286.108 214.615 276.339 187.918C270.825 156.896 270.664 140.434 279.012 113.93C278.085 153.859 280.556 172.357 292.378 195.706C312.427 254.118 351.188 290.464 388.613 287.867C398.591 279.521 397.312 272.894 397.969 261.907C398.604 239.927 393.196 231.41 379.256 219.071C367.985 210.861 362.765 205.747 355.198 195.706C349.833 178.941 349.663 168.912 352.524 150.275C355.901 139.451 358.763 134.997 364.554 128.208C356.528 158.518 355.993 172.657 367.227 189.216C378.462 205.725 388.613 213.879 397.969 215.177C412.744 214.617 416.067 206.904 419.354 189.216C421.405 169.28 420.371 159.659 416.681 143.785C437.256 187.889 437.464 205.925 418.018 224.263C408.873 249.625 409.54 263.172 419.354 286.569C450.002 303.629 463.63 313.262 471.481 330.703C471.789 335.985 469.617 338.24 462.125 341.087C459.884 334.478 464.184 332.197 476.828 329.405H503.56C512.046 329.976 515.148 332.053 518.262 338.491C507.385 337.621 502.654 335.593 502.223 322.915L571.726 259.311C574.9 244.687 570.405 239.801 555.687 234.648C499.786 215.211 483.905 197.752 475.491 158.063C492.225 192.323 504.805 203.04 534.301 203.495C557.379 198.104 559.746 185.102 554.35 152.871C548.736 132.129 535.66 121.992 506.233 104.843C543.552 111.847 558.117 121.649 567.716 154.169C570.575 158.823 571.453 171.833 573.063 194.408C575.569 213.373 577.598 223.637 589.102 237.244C628.061 216.074 630.11 200.605 637.219 173.64C643.883 110.893 634.006 79.3469 567.716 36.0472C606.431 44.3291 627.241 56.3311 659.941 113.93C676.825 69.3129 673.145 44.6451 654.595 1C672.142 25.6231 682.384 39.1432 684 74.9884C683.034 166.744 665.194 204.404 613.16 255.416C575.509 290.374 553.768 310.307 539.648 333.299C538.105 347.474 541.953 349.839 554.35 347.577L589.102 309.934C615.898 301.312 629.274 302.763 651.922 309.934C645.706 324.807 635.493 338.741 602.468 376.134C585.058 379.212 578.96 378.311 579.746 368.346C606.393 353.897 611.801 343.571 611.824 322.915C588.993 331.682 578.514 338.84 566.38 357.962L574.399 378.73C614.536 453.234 631.365 494.55 645.239 566.947C653.572 639.378 649.926 681.462 630.536 759.057C624.553 610.585 621.785 525.825 575.736 481.277C567.479 482.523 564.906 490.267 562.37 511.131C558.433 544.592 555.933 562.979 528.955 566.947C504.029 574.425 507.748 588.028 516.926 613.676C525.361 634.776 533.395 646.383 550.341 666.896C590.238 709.046 612.743 732.684 617.17 773.335L618.507 785.018"
            stroke="#FF0000" strokeWidth="4"
          />
          <path
            ref={pathRef2}
            d="M515.5 395.001C508.483 411.368 497.884 412.381 471.5 405C483.006 381.35 490.481 379.84 504.5 385C506.106 396.216 504.211 400.195 492 400.002C485.881 396.415 485.081 391.95 488.5 382.002C497.806 380.626 504.5 382.001 519.5 388.002C525.337 384.841 524.681 382.8 521 379.001C491.249 364.752 478.738 368.468 466 402.001"
            stroke="#FF0000" strokeWidth="3"
          />
        </svg>
      </div>
    </div>
  );
};

export default Loader;
